---
title: "Bulgaria's Weather & Climate"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r}
library(terra)
library(stars)
library(tidyverse)
library(lubridate)
library(rgdal)
library(sf)
library(ggthemes)
library(here)
```

Project 1: Create a space-time object of daily high/low temperatures and precipitation for all 1x1 km grid cells inside the boundary defined by Sofia grad over the period 1950-2020. Then examine climatologies / trends at specific locations (e.g., apartment).

Administrative boundaries https://data.humdata.org/dataset/bulgaria-administrative-level-0-2-boundaries
```{r}
#unzip(zipfile = "bgr_adm_unicef_2019_shp.zip", 
#      exdir = "Bulgaria")
Bulgaria0.sf <- st_read(dsn = "Bulgaria",
                        layer = "bgr_admbnda_adm0_UNICEF_2019")
plot(Bulgaria0.sf$geometry)

Bulgaria1.sf <- st_read(dsn = "Bulgaria",
                        layer = "bgr_admbnda_adm1_UNICEF_2019")
plot(Bulgaria1.sf$geometry)

SofiaCity.sf <- Bulgaria1.sf %>%
  filter(ADM1_EN == "Sofia-City")

Bulgaria2.sf <- st_read(dsn = "Bulgaria",
                        layer = "bgr_admbnda_adm2_UNICEF_2019")
plot(Bulgaria2.sf$geometry)

library(crsuggest)
suggest_crs(Bulgaria0.sf)
```

Get European Environment Agency (EEA) reference grid shapefiles at 1, 10, and 100 km resolution from https://www.eea.europa.eu/data-and-maps/data/eea-reference-grids-2/gis-files/bulgaria-shapefile
```{r}
unzip(zipfile = "Bulgaria_shapefile.zip", 
      exdir = "Bulgaria")
Bulgaria.sf <- st_read(dsn = "Bulgaria",
                       layer = "bg_100km")
plot(Bulgaria.sf$geometry)
```

Get European daily precip and tmax, tmin data from a cloud-optimized geotiff (COG) hosted at ftp://palantir.boku.ac.at/Public/ClimateData/

Readme.txt: 

https://frodriguezsanchez.net/post/accessing-data-from-large-online-rasters-with-cloud-optimized-geotiff-gdal-and-terra-r-package/

Temperatures are given as celsius * 100 and precipitation is given as mm * 100. For questions please contact: mathias.neumann@boku.ac.at v3 1950-2020

Citation: Moreno, A., & Hasenauer, H. (2015). Spatial downscaling of European climate data. International Journal of Climatology.DOI: 10.1002/joc.4436 https://rmets.onlinelibrary.wiley.com/doi/10.1002/joc.4436


Precipitation in 2020
```{r}
cog.url <- "/vsicurl/ftp://palantir.boku.ac.at/Public/ClimateData/v3_cogeo/AllDataRasters/prec/DownscaledPrcp2020_cogeo.tif"
ppt.r <- rast(cog.url)
# center lat/lon Sofia City district (23.39864 42.67827)

coords <- data.frame(lon = 23.39864, lat = 42.67827)
coords.apt <- data.frame(lon = 23.36161, lat = 42.67856)
SofiaPrcp2020 <- terra::extract(ppt.r,
                                coords.apt,
                                list = TRUE) |>
  unlist()
```

Daily high temperature in 2010
```{r}
cog.url <- "/vsicurl/ftp://palantir.boku.ac.at/Public/ClimateData/v3_cogeo/AllDataRasters/tmax/DownscaledTmax2020_cogeo.tif"
tmax.r <- rast(cog.url)
tmax.r
```

1 km elevation raster over Europe. https://www.eea.europa.eu/data-and-maps/data/digital-elevation-model-of-europe
```{r}
elev.r <- rast("elevation1x1_new.tif")
plot(elev.r)
```

Make Sofia city boundary a `vect` object and then crop the full raster to this object. This will create a smaller raster with the vector boundary defining the extent.
```{r}
SofiaCity.v <- vect(SofiaCity.sf)

tmax.r <- terra::crop(tmax.r,
                      SofiaCity.v) / 100

elev.r <- terra::project(elev.r, tmax.r)


coords.apt.v <- vect(coords.apt)
coords.v <- vect(coords)
#plot(tmax.r[[1]])
plot(elev.r)
plot(SofiaCity.v, add = TRUE)
plot(coords.apt.v, add = TRUE, col = "red")
```

Convert to {stars} object then crop to the Sofia city simple feature object. This will create a space-time vector object containing only cells whose center point fall within the simple feature.
```{r}
tmax.st <- st_as_stars(tmax.r)

dates <- seq.Date(from = as.Date("2010-01-01"),
                  to = as.Date("2010-12-31"),
                  by = "days")

tmax.st <- tmax.st |>
  st_set_dimensions(which = "band", 
                    values = dates, 
                    names = "time")

tmax.st <- tmax.st |>
  st_crop(SofiaCity.sf) |>
  setNames("Tmax_C")

X <- filter(tmax.st, 
            time == ymd("2010-01-01"))
plot(X)
```

Check temperature variations over 30 days in June.
```{r}
X <- filter(tmax.st, 
            time >= ymd("2010-06-01"), 
            time <= ymd("2010-06-30"))

ggplot() +  
  geom_stars(data = X["Tmax_C"], alpha = .8, downsample = c(0, 0, 0)) + 
  facet_wrap(~ time) +
  scale_fill_distiller(palette = "RdBu") +
  coord_equal() +
  theme_map() +
  theme(legend.position = "bottom") +
  theme(legend.key.width = unit(2, "cm"))
```

Convert daily `SpatRaster` object to a data frame with each row a grid location and columns 3:365 the daily values.
```{r}
Tmax.df <- as.data.frame(Tmax.r, xy = TRUE) %>%
  set_names(nm = c("lon", "lat", str_c("D", 1:365)))
head(Tmax.df[, 1:10])
range(Tmax.df[,-(1:2)])
```

## Import as space-time {stars} object and crop to the Sofia City boundary

```{r}
cog.url <- "/vsicurl/ftp://palantir.boku.ac.at/Public/ClimateData/v2_cogeo/AllDataRasters/prec/DownscaledPrcp2010_cogeo.tif"
ppt <- read_stars(cog.url)
cog.url <- "/vsicurl/ftp://palantir.boku.ac.at/Public/ClimateData/v2_cogeo/AllDataRasters/tmax/DownscaledTmax2010_cogeo.tif"
tmax <- read_stars(cog.url)
TP.st <- c(tmax, ppt) |>
    setNames(c("Tmax", "Prcp"))
dates <- seq.Date(from = as.Date("2010-01-01"),
                  to = as.Date("2010-12-31"),
                  by = "days")
TP.st <- TP.st |>
  st_set_dimensions(which = "band", 
                    values = dates, 
                    names = "days") |>
  st_crop(SofiaCity.sf)

X <- filter(TP.st["Tmax"], 
            time == ymd("2010-01-01"))
plot(X)
```

The database of Open Street Maps https://dominicroye.github.io/en/2018/accessing-openstreetmap-data-with-r/
```{r}
library(osmdata)
library(ggmap)

head(available_features())
head(available_tags("amenity"))
head(available_tags("shop"))
```

Build a query.
```{r}
q <- getbb("Sofia, Bulgaria") %>%
  opq() %>%
  add_osm_feature(key = "surface")
str(q)

surfaceRoads <- osmdata_sf(q)
plot(surfaceRoads$osm_lines$geometry)

q <- getbb("Sofia, Bulgaria") %>%
  opq() %>%
  add_osm_feature(key = "public_transport")
str(q)

publicTransport <- osmdata_sf(q)
plot(publicTransport$osm_lines$geometry)

q <- getbb("Sofia, Bulgaria") %>%
  opq() %>%
  add_osm_feature(key = "amenity",
                  value = "restaurant")
str(q)

restaurants <- osmdata_sf(q)
```

Make a map.
```{r}
mad_map <- get_map(getbb("Sofia, Bulgaria"), 
                   maptype = "toner-background",
                   source = "stamen")

coords.apt.sf <- st_as_sf(coords.apt.v) 
st_crs(coords.apt.sf) <- 4326

ggmap(mad_map) +
  geom_sf(data = coords.apt.sf,
          inherit.aes = FALSE,
          colour = "red")
```



Read CHIRPS with {stars} https://github.com/loreabad6/chirps-stars
```{r}
url <- "https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_daily/netcdf/p05/"
file <- "chirps-v2.0.1981.days_p05.nc"
fn <- paste0(url, file)

fn <- "chirps-v2.0.1981.01.01.tif"

chirps1981 <- read_stars(fn, NA_value = -9999)
chirps1981

url <- "https://data.chc.ucsb.edu/products/CHIRPS-2.0/global_daily/tifs/p05/1981/"
file <- "chirps-v2.0.1981.01.01.tif.gz"

download.file(url = paste0(url, file),
              destfile = "data/temp.zip.gz")
library(R.utils)
gunzip("data/temp.zip.gz")

chirps1981 <- read_stars("data/temp.zip.gz", NA_value = -9999)
```

Get climate data: 1958-2019
```{r}
df <- climateR::getTerraClim(Bulgaria0.sf, 
                             param = "tmax", 
                             startDate = "2019-07-04", 
                             endDate = "2019-07-04")[[1]]

plot(df)
plot(Bulgaria0.sf$geometry, 
     add = TRUE)

SofiaCity.sf <- Bulgaria1.sf %>%
  dplyr::filter(ADM1_EN == "Sofia-City")

df <- climateR::getTerraClim(SofiaCity.sf, 
                             param = "tmax", 
                             startDate = "2019-07-01", # monthly only
                             endDate = "2019-07-01")
plot(df$terraclim_tmax)
plot(SofiaCity.sf$geometry, 
     add = TRUE)
```

Convert to {stars} object.
```{r}
library(stars)

df <- climateR::getTerraClim(SofiaCity.sf, 
                             param = "tmax", 
                             startDate = "2019-01-01", 
                             endDate = "2019-12-01")

tmax.st <- st_as_stars(df$terraclim_tmax)

names(tmax.st) <- "C"

months <- seq(as_date("2019-01-01"), 
              as_date("2019-12-01"), 
              by = "month")

months <- month.abb

( tmax.st <- st_set_dimensions(tmax.st, 
                               which = 3, 
                               values = months, names = "month") )

X <- st_crop(tmax.st, 
             SofiaCity.sf, 
             crop = TRUE)

ggplot() +  
  geom_stars(data = X) + 
  facet_wrap("month") +
  scale_fill_viridis_c() +
  coord_sf() +
  theme_map() +
  theme(legend.position = "bottom") +
  theme(legend.key.width = unit(2, "cm"))
```

Get CHIRPS data. Daily rainfall rasters. https://www.chc.ucsb.edu/data/chirps. https://www.nature.com/articles/sdata201566

Daily rainfall in Sofia city amounts July 2019.
```{r}
t0 <- Sys.time()
start <- "2019-01-01"
end <- "2019-12-31"
df <- climateR::getCHIRPS(SofiaCity.sf, 
                          startDate = start, 
                          endDate = end) 
Sys.time() - t0

# Time difference of 4.4 mins

#library(rasterVis)
#levelplot(df)

prcp.st <- st_as_stars(df)
names(prcp.st) <- "mm"

days <- seq(as_date(start), 
            as_date(end), 
            by = "day")

( prcp.st <- st_set_dimensions(prcp.st, 
                               which = 3, 
                               values = days, names = "date") )

X <- st_crop(prcp.st, 
             SofiaCity.sf, 
             crop = TRUE)

ggplot() +  
  geom_stars(data = X) + 
  facet_wrap("date") +
  scale_fill_viridis_c() +
  coord_sf() +
  theme_map() +
  theme(legend.position = "bottom") +
  theme(legend.key.width = unit(2, "cm"))

prcp.st %>% 
  as_tibble() %>%
  group_by(date) %>% 
  summarize(avgR = mean(mm, na.rm = TRUE))
```

Daily rainfall amounts in Bulgaria March 2021.
```{r}
start <- "2021-03-01"
end <- "2021-03-31"
df <- climateR::getCHIRPS(Bulgaria0.sf, 
                          startDate = start, 
                          endDate = end) 

prcp.st <- st_as_stars(df)
names(prcp.st) <- "mm"

days <- seq(as_date(start), 
            as_date(end), 
            by = "day")

( prcp.st <- st_set_dimensions(prcp.st, 
                               which = 3, 
                               values = days, 
                               names = "date") )

X <- st_crop(prcp.st, 
             Bulgaria0.sf, 
             crop = TRUE)

ggplot() +  
  geom_stars(data = X) + 
  facet_wrap("date") +
  scale_fill_viridis_c() +
  coord_sf() +
  theme_map() +
  theme(legend.position = "bottom") +
  theme(legend.key.width = unit(2, "cm"))
```


```{r}
# remotes::install_github("mikejohnson51/AOI")
# remotes::install_github("mikejohnson51/climateR")
library(raster)
library(AOI)
library(climateR)
select <- dplyr::select  # make sure that the select you want is from {dplyr} (not the one in {raster})

country_of_interest <- "Bulgaria"
AOI <- aoi_get(country = country_of_interest)
plot(AOI$geometry)
```